<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å£“åŠ›é‡‹æ”¾å™¨ (Stress Breaker)</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ Tone.js (ç”¨æ–¼ç”¢ç”Ÿè²éŸ³) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        /* è¨­å®šå­—é«”ç‚º Inter */
        html { font-family: 'Inter', sans-serif; }
        
        /* éš±è—é è¨­çš„è¨Šæ¯æ¡† */
        #message-box {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            transform: translateY(-20px);
        }
        .message-show {
            opacity: 1 !important;
            transform: translateY(0) !important;
        }

        /* ç¢ºä¿ Canvas ä½”æ»¿å…¶å®¹å™¨ */
        #glassCanvas {
            cursor: crosshair;
            display: block;
        }

        /* äº’å‹•æŒ‰éˆ•æ¨£å¼ */
        .btn-primary {
            @apply px-4 py-2 text-sm md:text-base font-semibold rounded-full shadow-lg transition duration-200 ease-in-out whitespace-nowrap;
        }

    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col items-center justify-center p-4">

    <!-- ä¸»æ‡‰ç”¨ç¨‹å¼å®¹å™¨ -->
    <div class="w-full max-w-4xl mx-auto flex flex-col items-center space-y-8">
        
        <h1 class="text-4xl md:text-5xl font-extrabold text-red-400 mt-8 mb-4">
            ğŸ”¨ ç›®æ¨™é‡‹æ”¾å™¨ ğŸ”¨
        </h1>
        
        <!-- æŒ‡ç¤ºå€å¡Š -->
        <div class="bg-gray-800 p-4 md:p-6 rounded-xl shadow-2xl w-full">
            <p class="text-lg text-gray-300 flex items-center justify-center space-x-2 mb-4">
                <span class="text-red-300 font-semibold text-center">
                    æ­¥é©Ÿ 1. é¸æ“‡ç›®æ¨™æˆ–ä¸Šå‚³åœ–åƒ | æ­¥é©Ÿ 2. é»æ“Šç›®æ¨™ç›´åˆ°å®ƒå®Œå…¨ç ´ç¢ï¼
                </span>
            </p>
            
            <!-- é¸é …æŒ‰éˆ• -->
            <div class="flex flex-wrap justify-center gap-2 md:gap-4 border-b pb-4 border-gray-700">
                <button id="selectCircle" class="btn-primary bg-blue-600 hover:bg-blue-500 text-white">åœ“å½¢ç»ç’ƒ</button>
                <button id="selectTarget" class="btn-primary bg-purple-600 hover:bg-purple-500 text-white">é¶å¿ƒåœ–æ¡ˆ</button>
                <button id="selectSquare" class="btn-primary bg-yellow-600 hover:bg-yellow-500 text-gray-900">æ–¹å½¢ç»ç’ƒ</button>
                <button id="selectHeart" class="btn-primary bg-red-600 hover:bg-red-500 text-white">ğŸ’” å¿ƒç¢ç›®æ¨™</button>
            </div>

            <!-- åœ–åƒä¸Šå‚³å€ -->
            <div class="flex flex-col items-center mt-4">
                <label for="imageUpload" class="text-sm text-gray-400 mb-2">æˆ–ä¸Šå‚³æ‚¨çš„ç›®æ¨™åœ–åƒ (æ”¯æ´ JPG/PNG):</label>
                <input type="file" id="imageUpload" accept="image/png, image/jpeg" class="text-sm text-gray-300 p-2 rounded-lg bg-gray-700 hover:bg-gray-600 cursor-pointer w-full max-w-sm">
            </div>
            
            <div class="flex justify-center mt-4">
                <button id="resetButton" class="btn-primary bg-gray-500 hover:bg-gray-400 text-white">ğŸ¯ é‡ç½®ç›®æ¨™/ç•«å¸ƒ</button>
            </div>
        </div>

        <!-- è™›æ“¬ç»ç’ƒ/ç•«å¸ƒå€åŸŸ -->
        <div class="w-full h-96 md:h-[480px] bg-gray-950 border-4 border-gray-700 rounded-xl overflow-hidden shadow-2xl relative">
            <canvas id="glassCanvas" class="w-full h-full"></canvas>
            
            <!-- åˆå§‹æç¤ºæ–‡å­— -->
            <div id="initial-prompt" class="absolute inset-0 flex items-center justify-center transition-opacity duration-500 pointer-events-none">
                <p class="text-gray-500 text-2xl font-light tracking-wider opacity-75 text-center px-4">
                    è«‹å…ˆé»æ“Šä¸Šæ–¹çš„æŒ‰éˆ•æˆ–ä¸Šå‚³åœ–åƒä¾†é¸æ“‡æ‚¨çš„ç›®æ¨™ï¼
                </p>
            </div>
        </div>

        <!-- è¨Šæ¯å½ˆå‡ºè¦–çª— -->
        <div id="message-box" class="fixed top-0 mt-4 mx-auto bg-green-500 text-gray-900 font-bold py-3 px-6 rounded-full shadow-2xl opacity-0">
            æƒ…ç·’å·²é‡‹æ”¾ï¼ç¹¼çºŒé»æ“Šç›´åˆ°æ‚¨æ„Ÿè¦ºå¥½ä¸€äº›ï¼
        </div>

    </div>

    <script>
        const canvas = document.getElementById('glassCanvas');
        const ctx = canvas.getContext('2d');
        const messageBox = document.getElementById('message-box');
        const initialPrompt = document.getElementById('initial-prompt');
        const selectCircleBtn = document.getElementById('selectCircle');
        const selectTargetBtn = document.getElementById('selectTarget');
        const selectSquareBtn = document.getElementById('selectSquare');
        const selectHeartBtn = document.getElementById('selectHeart');
        const imageUploadInput = document.getElementById('imageUpload');
        const resetButton = document.getElementById('resetButton');
        
        // --- ç‹€æ…‹ç®¡ç† ---
        let currentShape = null; // 'circle', 'target', 'square', 'heart', or 'image'
        let target = { 
            x: 0, y: 0, // ä¸­å¿ƒé»
            boundX: 0, boundY: 0, boundW: 0, boundH: 0, // é»æ“Šåµæ¸¬çš„çŸ©å½¢ç¯„åœ
            radius: 0, size: 0, // ç¹ªåœ–å°ºå¯¸
            hits: 0, maxHits: 20, isShattered: false 
        }; 
        let cracks = [];
        let uploadedImage = null; // å„²å­˜ Image ç‰©ä»¶
        let isAudioReady = false;

        // --- Tone.js è²éŸ³åˆæˆå™¨ ---
        const breakSynth = new Tone.NoiseSynth({
            noise: { type: "white" },
            envelope: { attack: 0.005, decay: 0.4, sustain: 0.0, release: 0.01 }
        }).toDestination();

        // èª¿æ•´ Canvas å¤§å°ä¸¦è¨­å®šç›®æ¨™ä¸­å¿ƒé»
        function resizeCanvas() {
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            
            // åŸºç¤å°ºå¯¸è¨­å®š
            target.x = canvas.width / 2;
            target.y = canvas.height / 2;
            target.size = Math.min(canvas.width, canvas.height) / 3;
            target.radius = target.size;

            // èª¿æ•´é‚Šç•Œç›’ (Bound Box)
            if (currentShape === 'square' || currentShape === 'heart' || currentShape === 'image') {
                target.boundW = target.size * 1.5;
                target.boundH = target.size * 1.5;
                if (currentShape === 'image' && uploadedImage) {
                    // ä¿æŒåœ–åƒæ¯”ä¾‹ï¼Œè®“æœ€é•·é‚Šç­‰æ–¼ target.size * 1.5
                    const ratio = uploadedImage.width / uploadedImage.height;
                    if (ratio > 1) { // å¯¬åº¦å¤§æ–¼é«˜åº¦
                        target.boundW = target.size * 1.5;
                        target.boundH = target.boundW / ratio;
                    } else { // é«˜åº¦å¤§æ–¼æˆ–ç­‰æ–¼å¯¬åº¦
                        target.boundH = target.size * 1.5;
                        target.boundW = target.boundH * ratio;
                    }
                }
                target.boundX = target.x - target.boundW / 2;
                target.boundY = target.y - target.boundH / 2;
            } else {
                 // åœ“å½¢/é¶å¿ƒ
                target.boundW = target.radius * 2;
                target.boundH = target.radius * 2;
                target.boundX = target.x - target.radius;
                target.boundY = target.y - target.radius;
            }

            draw();
        }
        
        // ç¹ªè£½æ„›å¿ƒå½¢ç‹€
        function drawHeartShape(x, y, size, context) {
            context.beginPath();
            const k = size / 2; // ç¸®æ”¾ä¿‚æ•¸
            context.moveTo(x, y + k / 4);
            // å·¦åŠé‚Š
            context.bezierCurveTo(
                x + k / 2, y - k,
                x + k, y - k / 2,
                x, y + k * 1.5 // å°–ç«¯
            );
            // å³åŠé‚Š
            context.bezierCurveTo(
                x - k, y - k / 2,
                x - k / 2, y - k,
                x, y + k / 4
            );
        }

        // --- ç¹ªè£½ç›®æ¨™å½¢ç‹€ ---
        function drawShape() {
            if (!currentShape) return;
            
            ctx.strokeStyle = `rgba(147, 197, 253, 0.9)`; // light-blue-300
            ctx.lineWidth = 4;
            
            if (currentShape === 'circle') {
                ctx.beginPath();
                ctx.arc(target.x, target.y, target.radius, 0, Math.PI * 2);
                ctx.stroke();
            } else if (currentShape === 'target') {
                for (let i = 0; i < 4; i++) {
                    const r = target.radius * (1 - i * 0.25);
                    ctx.beginPath();
                    ctx.arc(target.x, target.y, r, 0, Math.PI * 2);
                    if (i === 1 || i === 3) {
                        ctx.fillStyle = `rgba(239, 68, 68, 0.1)`; 
                        ctx.fill();
                    }
                    ctx.stroke();
                }
            } else if (currentShape === 'square') {
                ctx.strokeRect(target.boundX, target.boundY, target.boundW, target.boundH);
            } else if (currentShape === 'heart') {
                drawHeartShape(target.x, target.y, target.size, ctx);
                ctx.fillStyle = `rgba(239, 68, 68, 0.1)`; 
                ctx.fill();
                ctx.stroke();
            } else if (currentShape === 'image' && uploadedImage) {
                // ç¹ªè£½åœ–åƒ
                ctx.drawImage(uploadedImage, target.boundX, target.boundY, target.boundW, target.boundH);
                // åœ–åƒé‚Šæ¡†
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
                ctx.lineWidth = 2;
                ctx.strokeRect(target.boundX, target.boundY, target.boundW, target.boundH);
            }
            
            // æç¤ºé»æ“Šæ•¸ 
            if (!target.isShattered && currentShape !== 'image') {
                 ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
                 ctx.font = '20px Inter, sans-serif';
                 ctx.textAlign = 'center';
                 ctx.fillText(`å‰©é¤˜ ${target.maxHits - target.hits} æ¬¡æ•²æ“Š`, target.x, target.y + target.size + 30);
            } else if (!target.isShattered && currentShape === 'image') {
                 ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
                 ctx.font = '20px Inter, sans-serif';
                 ctx.textAlign = 'center';
                 ctx.fillText(`å‰©é¤˜ ${target.maxHits - target.hits} æ¬¡æ•²æ“Š (ç ¸çˆ›åœ–åƒ!)`, target.x, target.y + target.boundH / 2 + 30);
            }
        }

        // --- ç¹ªè£½å–®ä¸€è£‚ç—• ---
        function drawCrack(crack) {
            ctx.beginPath();
            
            // è£‚ç—•å¾é»æ“Šä¸­å¿ƒå‘å¤–æ“´æ•£
            for (let i = 0; i < 15; i++) {
                const angle = (Math.random() * Math.PI * 2) + crack.angleOffset + (i * 0.3);
                const length = Math.random() * (70 + target.hits * 5) + 30; // è£‚ç—•é•·åº¦éš¨ hits å¢åŠ 
                
                const endX = crack.x + Math.cos(angle) * length;
                const endY = crack.y + Math.sin(angle) * length;
                
                ctx.moveTo(crack.x, crack.y);
                ctx.lineTo(endX, endY);
            }

            ctx.lineWidth = 2;
            ctx.strokeStyle = crack.color;
            ctx.lineCap = 'round';
            ctx.stroke();
        }

        // --- æ¸²æŸ“æ‰€æœ‰å…ƒç´  ---
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height); 

            drawShape();
            
            // ç¹ªè£½ç¾æœ‰çš„æ‰€æœ‰è£‚ç—•
            cracks.forEach(drawCrack);
            
            // å¦‚æœå®Œå…¨ç ´ç¢ï¼Œé¡¯ç¤º SHATTERED æ•ˆæœ
            if (target.isShattered) {
                ctx.fillStyle = 'rgba(239, 68, 68, 0.9)'; // Red overlay
                ctx.font = 'bold 80px Inter, sans-serif';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText("SHATTERED!", target.x, target.y);
                
                // é¡å¤–ç¹ªè£½ä¸€äº›ç ´ç¢çš„é‚Šç·£ç·šæ¢
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
                ctx.lineWidth = 1;
                for(let i = 0; i < 100; i++) {
                    ctx.beginPath();
                    ctx.moveTo(target.x, target.y);
                    const angle = Math.random() * Math.PI * 2;
                    const length = Math.min(canvas.width, canvas.height) / 2;
                    ctx.lineTo(target.x + Math.cos(angle) * length, target.y + Math.sin(angle) * length);
                    ctx.stroke();
                }
            }
        }
        
        // --- é»æ“Šè™•ç†å‡½æ•¸ ---
        function handleSmash(event) {
            if (!currentShape) {
                showMessage("è«‹å…ˆé¸æ“‡ä¸€å€‹ç›®æ¨™ï¼", "bg-yellow-500", 1500);
                return;
            }
            if (target.isShattered) {
                showMessage("ç›®æ¨™å·²ç ´ç¢ï¼Œè«‹é‡ç½®ï¼", "bg-red-500", 1500);
                return;
            }

            // å•Ÿç”¨ Audio Context
            if (!isAudioReady) {
                Tone.start().then(() => { isAudioReady = true; });
            }

            // è¨ˆç®—é»æ“Šä½ç½®ç›¸å°æ–¼ Canvas çš„åº§æ¨™
            const rect = canvas.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;

            let isHit = false;
            
            // é»æ“Šåµæ¸¬é‚è¼¯
            if (currentShape === 'circle' || currentShape === 'target') {
                // åœ“å½¢åµæ¸¬
                const distance = Math.sqrt(Math.pow(x - target.x, 2) + Math.pow(y - target.y, 2));
                isHit = distance <= target.radius;
            } else {
                // çŸ©å½¢é‚Šç•Œç›’åµæ¸¬ (é©ç”¨æ–¼ square, heart, image)
                isHit = x >= target.boundX && x <= target.boundX + target.boundW && 
                        y >= target.boundY && y <= target.boundY + target.boundH;
            }
            
            if (isHit) {
                // å‘½ä¸­ç›®æ¨™
                if (isAudioReady) {
                    // éš¨æ©ŸéŸ³é«˜è®ŠåŒ–ï¼Œè®“ç ´ç¢è²è½èµ·ä¾†æ›´å¤šæ¨£
                    breakSynth.triggerAttackRelease(Math.random() > 0.5 ? "8n" : "16n", Tone.now(), Math.random() * 0.5 + 0.5); 
                }
                
                target.hits++;
                
                // ç”¢ç”Ÿä¸€å€‹æ–°çš„è£‚ç—•æ•¸æ“š
                const newCrack = {
                    x: x,
                    y: y,
                    color: 'rgba(239, 68, 68, 0.8)', // ç´…è‰²è£‚ç—•
                    angleOffset: Math.random() * Math.PI * 2 
                };
                cracks.push(newCrack);

                // æª¢æŸ¥æ˜¯å¦å®Œå…¨ç ´ç¢
                if (target.hits >= target.maxHits) {
                    target.isShattered = true;
                    showMessage("ç›®æ¨™å®Œå…¨ç ´ç¢ï¼ğŸ‰ å£“åŠ›é‡‹æ”¾å®Œç•¢ï¼", "bg-red-500", 3000);
                } else {
                    showMessage("ç °ï¼å‘½ä¸­ç›®æ¨™ã€‚ç¹¼çºŒï¼", "bg-green-500", 1000);
                }
            } else {
                // æœªå‘½ä¸­ç›®æ¨™
                if (isAudioReady) {
                    breakSynth.triggerAttackRelease("32n"); 
                }
                showMessage("éŒ¯éäº†ï¼è«‹é›†ä¸­æ³¨æ„åŠ›ã€‚", "bg-yellow-500", 1000);
            }

            // æ›´æ–°è¦–è¦ºæ•ˆæœ
            draw();
        }

        // --- è¨Šæ¯é¡¯ç¤ºé‚è¼¯ ---
        let messageTimeout;
        function showMessage(text, colorClass, duration = 2000) {
            clearTimeout(messageTimeout);
            messageBox.textContent = text;
            // å‹•æ…‹æ›¿æ›èƒŒæ™¯é¡è‰²é¡
            messageBox.className = messageBox.className.replace(/bg-[a-z]+-\d+/g, colorClass);
            messageBox.classList.add('message-show');
            
            messageTimeout = setTimeout(() => {
                messageBox.classList.remove('message-show');
            }, duration); 
        }
        
        // --- ç›®æ¨™é¸æ“‡å‡½æ•¸ ---
        function selectShape(shapeType) {
            currentShape = shapeType;
            // éš±è—åˆå§‹æç¤º
            initialPrompt.style.opacity = '0';
            setTimeout(() => { initialPrompt.style.display = 'none'; }, 500);

            resetTarget(false); // é‡è¨­ç‹€æ…‹ï¼Œä½†ä¸æ¸…é™¤æç¤º
            
            // æ¸…é™¤æ‰€æœ‰æŒ‰éˆ•çš„é¸ä¸­æ¨£å¼
            [selectCircleBtn, selectTargetBtn, selectSquareBtn, selectHeartBtn].forEach(btn => {
                btn.classList.remove('bg-blue-800', 'bg-purple-800', 'bg-yellow-800', 'bg-red-800');
            });

            // è¨­å®šé¸ä¸­çš„æŒ‰éˆ•æ¨£å¼
            let msg = "";
            let btnToHighlight;
            switch(shapeType) {
                case 'circle': msg = "å·²é¸å–åœ“å½¢ç›®æ¨™ã€‚"; btnToHighlight = selectCircleBtn; break;
                case 'target': msg = "å·²é¸å–é¶å¿ƒåœ–æ¡ˆã€‚"; btnToHighlight = selectTargetBtn; break;
                case 'square': msg = "å·²é¸å–æ–¹å½¢ç›®æ¨™ã€‚"; btnToHighlight = selectSquareBtn; break;
                case 'heart': msg = "å·²é¸å–å¿ƒç¢ç›®æ¨™ã€‚"; btnToHighlight = selectHeartBtn; break;
                case 'image': msg = "å·²é¸å–ä¸Šå‚³åœ–åƒä½œç‚ºç›®æ¨™ã€‚"; break;
            }
            if (btnToHighlight) {
                 btnToHighlight.classList.add(`bg-${btnToHighlight.id.replace('select', '').toLowerCase().replace('target', 'purple').replace('circle', 'blue').replace('square', 'yellow').replace('heart', 'red')}-800`);
            }
            
            resizeCanvas(); // é‡æ–°è¨ˆç®—é‚Šç•Œç›’å’Œå°ºå¯¸
            showMessage(msg + "é–‹å§‹æ•²æ“Šï¼", "bg-green-500", 1500);
        }
        
        // --- åœ–åƒä¸Šå‚³è™•ç† ---
        imageUploadInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

            uploadedImage = new Image();
            const reader = new FileReader();
            
            reader.onload = (e) => {
                uploadedImage.onload = () => {
                    selectShape('image');
                };
                uploadedImage.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });

        // --- é‡ç½®å‡½æ•¸ ---
        function resetTarget(showPrompt = true) {
            cracks = [];
            target.hits = 0;
            target.isShattered = false;
            uploadedImage = null;
            imageUploadInput.value = ''; // æ¸…é™¤æª”æ¡ˆè¼¸å…¥
            
            if (showPrompt) {
                currentShape = null; // æ¸…é™¤é¸æ“‡
                initialPrompt.style.display = 'flex';
                initialPrompt.style.opacity = '1';
                // æ¸…é™¤æ‰€æœ‰æŒ‰éˆ•çš„é¸ä¸­æ¨£å¼
                [selectCircleBtn, selectTargetBtn, selectSquareBtn, selectHeartBtn].forEach(btn => {
                    btn.classList.remove('bg-blue-800', 'bg-purple-800', 'bg-yellow-800', 'bg-red-800');
                });
                showMessage("ç›®æ¨™å·²é‡ç½®ã€‚è«‹é‡æ–°é¸æ“‡ï¼", "bg-gray-500", 2000);
            }
            
            resizeCanvas(); // é‡æ–°ç¹ªè£½
        }

        // --- äº‹ä»¶ç›£è½å™¨ ---
        window.addEventListener('resize', resizeCanvas);
        canvas.addEventListener('click', handleSmash);
        selectCircleBtn.addEventListener('click', () => selectShape('circle'));
        selectTargetBtn.addEventListener('click', () => selectShape('target'));
        selectSquareBtn.addEventListener('click', () => selectShape('square'));
        selectHeartBtn.addEventListener('click', () => selectShape('heart'));
        resetButton.addEventListener('click', () => resetTarget(true));
        
        // åˆå§‹åŒ–
        resizeCanvas();
        draw(); 

    </script>
</body>
</html>